import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import classification_report, accuracy_score, confusion_matrix
from sklearn.preprocessing import LabelEncoder

data = pd.read_csv("plant_data.csv")
required = ["color", "texture", "label"]
missing_cols = [c for c in required if c not in data.columns]
if missing_cols:
    raise ValueError(f"Missing required columns: {missing_cols}")
for col in ["color", "texture"]:
    data[col] = pd.to_numeric(data[col], errors="coerce")
data = data.dropna(subset=required)
if len(data) < 2:
    raise ValueError("Need at least 2 rows of data after cleaning.")

le = LabelEncoder()
data["label_encoded"] = le.fit_transform(data["label"])
all_labels = list(range(len(le.classes_)))

X = data[["color", "texture"]]
y = data["label_encoded"]

test_size = 0.2
if len(data) * test_size < 1:
    test_size = 1 / len(data)

X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=test_size, random_state=42
)

model = RandomForestClassifier(n_estimators=200, random_state=42, n_jobs=-1)
model.fit(X_train, y_train)

y_pred = model.predict(X_test)

print(f"Accuracy: {accuracy_score(y_test, y_pred):.4f}\n")
print("Classification report:\n")
print(classification_report(
    y_test, y_pred, labels=all_labels, target_names=le.classes_, zero_division=0
))

cm = confusion_matrix(y_test, y_pred, labels=all_labels)
cm_df = pd.DataFrame(cm, index=le.classes_, columns=le.classes_)
print("Confusion matrix (rows=true, cols=pred):\n")
print(cm_df)

example = pd.DataFrame([{"color": 0.6, "texture": 0.4}])
pred_example = le.inverse_transform(model.predict(example))
print("\nExample prediction:", {"input": example.iloc[0].to_dict(), "pred": pred_example[0]})
